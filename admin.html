<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin - Cool Energy Abanicos</title>
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #111111;
      --bg-card: #1a1a1a;
      --text-primary: #f0f0f0;
      --text-secondary: #a0a0a0;
      --neon-magenta: #ff00ff;
      --neon-cyan: #00ffff;
      --neon-pink: #ff1493;
      --gradient-neon: linear-gradient(90deg, #ff00ff, #00ffff);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Quicksand', sans-serif;
      background: url('images/hero-bg.png') center center / cover no-repeat fixed;
      color: var(--text-primary);
      min-height: 100vh;
      padding: 2rem;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 10, 10, 0.85);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 0.5rem;
      background: var(--gradient-neon);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: 2rem;
    }

    /* Login Screen */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
    }

    .login-box {
      background: var(--bg-card);
      padding: 2rem;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
    }

    .login-box h2 {
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    input, select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 1rem;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--neon-cyan);
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: var(--gradient-neon);
      color: var(--bg-primary);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(255, 0, 255, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .error {
      color: var(--neon-pink);
      text-align: center;
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    /* Admin Panel */
    .admin-panel {
      display: none;
    }

    .admin-panel.active {
      display: block;
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card h3 {
      margin-bottom: 1rem;
      color: var(--neon-cyan);
    }

    .upload-area {
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s, background 0.3s;
    }

    .upload-area:hover {
      border-color: var(--neon-magenta);
      background: rgba(255, 0, 255, 0.05);
    }

    .upload-area.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .upload-area.disabled:hover {
      border-color: rgba(255,255,255,0.2);
      background: transparent;
    }

    .upload-area.has-file {
      border-color: var(--neon-cyan);
      background: rgba(0, 255, 255, 0.05);
    }

    .upload-area svg {
      width: 48px;
      height: 48px;
      margin-bottom: 1rem;
      color: var(--text-secondary);
    }

    .upload-area p {
      color: var(--text-secondary);
    }

    /* Image Preview */
    .image-preview {
      display: none;
      margin-top: 1rem;
      position: relative;
    }

    .image-preview.active {
      display: block;
    }

    .image-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      object-fit: contain;
    }

    .image-preview .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: rgba(255, 20, 147, 0.9);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-preview .file-name {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* Progress Bar */
    .progress-container {
      display: none;
      margin-top: 1rem;
    }

    .progress-container.active {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: var(--gradient-neon);
      transition: width 0.3s ease;
    }

    .progress-text {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-align: center;
    }

    /* Upload Button */
    .upload-btn {
      margin-top: 1rem;
    }

    .upload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .upload-btn:disabled:hover {
      box-shadow: none;
    }

    .category-select {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .category-option {
      padding: 1rem;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .category-option:hover {
      border-color: rgba(255,255,255,0.3);
    }

    .category-option.selected {
      border-color: var(--neon-magenta);
      background: rgba(255, 0, 255, 0.1);
    }

    .category-option span {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .category-option small {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    /* Uploaded Images */
    .uploaded-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .uploaded-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg-secondary);
    }

    .uploaded-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .uploaded-item .badge {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 4px 8px;
      background: rgba(0,0,0,0.7);
      border-radius: 4px;
      font-size: 0.7rem;
      color: var(--neon-cyan);
    }

    .uploaded-item .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      background: rgba(255, 20, 147, 0.9);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .uploaded-item:hover .delete-btn {
      opacity: 1;
    }

    /* Gallery Animations */
    @keyframes adminItemEnter {
      0% {
        opacity: 0;
        transform: scale(0.8) translateY(15px);
      }
      60% {
        transform: scale(1.03) translateY(-3px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    @keyframes adminItemExit {
      0% {
        opacity: 1;
        transform: scale(1);
      }
      100% {
        opacity: 0;
        transform: scale(0.7) translateY(-15px);
      }
    }

    .uploaded-item.item-enter {
      animation: adminItemEnter 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .uploaded-item.item-exit {
      animation: adminItemExit 0.25s ease-out forwards;
      pointer-events: none;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .success-msg {
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid var(--neon-cyan);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 1rem;
      color: var(--neon-cyan);
    }

    .back-link {
      display: inline-block;
      margin-bottom: 1rem;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.9rem;
    }

    .back-link:hover {
      color: var(--neon-cyan);
    }

    .logout-btn {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 8px 16px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      font-family: inherit;
      z-index: 10;
    }

    .logout-btn:hover {
      border-color: var(--neon-pink);
      color: var(--neon-pink);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: var(--bg-secondary);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    .stat-card .number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--neon-magenta);
    }

    .stat-card .label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    /* Analytics Card */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .analytics-stat {
      background: var(--bg-secondary);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    .analytics-stat .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--neon-cyan);
    }

    .analytics-stat .label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    @media (max-width: 600px) {
      .category-select {
        grid-template-columns: 1fr;
      }
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
      .analytics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">&larr; Volver al sitio</a>
    <h1>Cool Energy Admin</h1>
    <p class="subtitle">Gestion de abanicos</p>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
      <div class="login-box">
        <h2>Ingresar</h2>
        <form id="loginForm">
          <div class="form-group">
            <label for="passwordInput">Password</label>
            <input type="password" id="passwordInput" placeholder="Ingresa el password" required autocomplete="current-password">
          </div>
          <button type="submit" class="btn" id="loginBtn">Entrar</button>
        </form>
        <p class="error" id="loginError" style="display: none;"></p>
      </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
      <button class="logout-btn" onclick="logout()">Salir</button>

      <!-- Analytics -->
      <div class="card">
        <h3>Analytics</h3>
        <div class="analytics-grid">
          <div class="analytics-stat">
            <div class="value" id="analyticsPageviews">-</div>
            <div class="label">Visitas hoy</div>
          </div>
          <div class="analytics-stat">
            <div class="value" id="analyticsSessions">-</div>
            <div class="label">Sesiones unicas</div>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="number" id="statTotal">-</div>
          <div class="label">Total</div>
        </div>
        <div class="stat-card">
          <div class="number" id="statRaveXL">-</div>
          <div class="label">RAVE XL</div>
        </div>
        <div class="stat-card">
          <div class="number" id="statRaveL">-</div>
          <div class="label">RAVE L</div>
        </div>
        <div class="stat-card">
          <div class="number" id="statMedium">-</div>
          <div class="label">MEDIUM</div>
        </div>
      </div>

      <!-- Upload Card -->
      <div class="card">
        <h3>Subir nuevo abanico</h3>

        <label>1. Selecciona la categoria:</label>
        <div class="category-select" id="categorySelect">
          <div class="category-option" data-category="rave-xl">
            <span>RAVE XL</span>
            <small>66cm - Festivales</small>
          </div>
          <div class="category-option" data-category="rave-l">
            <span>RAVE L</span>
            <small>50cm - Versatil</small>
          </div>
          <div class="category-option" data-category="medium">
            <span>MEDIUM</span>
            <small>40cm - Diario</small>
          </div>
          <div class="category-option" data-category="personalizados">
            <span>PERSONALIZADOS</span>
            <small>A pedido</small>
          </div>
        </div>

        <label>2. Selecciona la imagen:</label>
        <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp" style="display: none;">
        <div class="upload-area disabled" id="uploadArea">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <p id="uploadAreaText">Primero selecciona una categoria</p>
          <p><small>JPG, PNG, WEBP - Max 10MB</small></p>
        </div>

        <!-- Image Preview -->
        <div class="image-preview" id="imagePreview">
          <img id="previewImg" src="" alt="Preview">
          <button class="remove-btn" id="removeBtn" title="Quitar imagen">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
          <p class="file-name" id="fileName"></p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <p class="progress-text" id="progressText">Subiendo... 0%</p>
        </div>

        <button class="btn upload-btn" id="uploadBtn" disabled>
          Subir a Cloudinary
        </button>

        <div id="successMsg" class="success-msg" style="display: none;">
          Imagen subida correctamente!
        </div>
      </div>

      <!-- Gallery Card -->
      <div class="card">
        <h3>Imagenes subidas</h3>
        <div class="form-group">
          <label for="filterCategory">Filtrar por categoria</label>
          <select id="filterCategory">
            <option value="all">Todas las categorias</option>
            <option value="rave-xl">RAVE XL</option>
            <option value="rave-l">RAVE L</option>
            <option value="medium">MEDIUM</option>
            <option value="personalizados">Personalizados</option>
          </select>
        </div>
        <div id="uploadedImages" class="uploaded-grid">
          <div class="loading">Cargando imagenes...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ================== Auth Service ==================
    const AuthService = {
      tokenKey: 'adminToken',

      getToken() {
        return localStorage.getItem(this.tokenKey);
      },

      setToken(token) {
        localStorage.setItem(this.tokenKey, token);
      },

      removeToken() {
        localStorage.removeItem(this.tokenKey);
      },

      isAuthenticated() {
        const token = this.getToken();
        if (!token) return false;

        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload.exp * 1000 > Date.now();
        } catch {
          return false;
        }
      },

      getAuthHeaders() {
        const token = this.getToken();
        return token ? { 'Authorization': `Bearer ${token}` } : {};
      }
    };

    // ================== API Service ==================
    const ApiService = {
      async request(url, options = {}) {
        const headers = {
          'Content-Type': 'application/json',
          ...AuthService.getAuthHeaders(),
          ...options.headers
        };

        const response = await fetch(url, { ...options, headers });

        if (response.status === 401 || response.status === 403) {
          AuthService.removeToken();
          location.reload();
          return;
        }

        return response.json();
      },

      async login(password) {
        return this.request('/api/auth/login', {
          method: 'POST',
          body: JSON.stringify({ password })
        });
      },

      async getStats() {
        return this.request('/api/stats');
      },

      async getImages(category = 'all') {
        return this.request(`/api/images?category=${category}`);
      },

      async getUploadSignature(category) {
        return this.request('/api/upload/signature', {
          method: 'POST',
          body: JSON.stringify({ category })
        });
      },

      async deleteImage(publicId) {
        return this.request(`/api/images/${encodeURIComponent(publicId)}`, {
          method: 'DELETE'
        });
      },

      async getAnalytics() {
        return this.request('/api/analytics');
      }
    };

    // ================== UI Controller ==================
    const UIController = {
      elements: {
        loginScreen: document.getElementById('loginScreen'),
        adminPanel: document.getElementById('adminPanel'),
        loginForm: document.getElementById('loginForm'),
        loginError: document.getElementById('loginError'),
        loginBtn: document.getElementById('loginBtn'),
        passwordInput: document.getElementById('passwordInput'),
        uploadedImages: document.getElementById('uploadedImages'),
        filterCategory: document.getElementById('filterCategory'),
        uploadArea: document.getElementById('uploadArea'),
        uploadAreaText: document.getElementById('uploadAreaText'),
        fileInput: document.getElementById('fileInput'),
        imagePreview: document.getElementById('imagePreview'),
        previewImg: document.getElementById('previewImg'),
        removeBtn: document.getElementById('removeBtn'),
        fileName: document.getElementById('fileName'),
        progressContainer: document.getElementById('progressContainer'),
        progressFill: document.getElementById('progressFill'),
        progressText: document.getElementById('progressText'),
        uploadBtn: document.getElementById('uploadBtn'),
        successMsg: document.getElementById('successMsg')
      },

      selectedCategory: null,
      selectedFile: null,

      showError(message) {
        this.elements.loginError.textContent = message;
        this.elements.loginError.style.display = 'block';
      },

      hideError() {
        this.elements.loginError.style.display = 'none';
      },

      showAdminPanel() {
        this.elements.loginScreen.style.display = 'none';
        this.elements.adminPanel.classList.add('active');
      },

      showLoginScreen() {
        this.elements.loginScreen.style.display = 'flex';
        this.elements.adminPanel.classList.remove('active');
      },

      setLoading(isLoading) {
        this.elements.loginBtn.disabled = isLoading;
        this.elements.loginBtn.textContent = isLoading ? 'Cargando...' : 'Entrar';
      },

      updateStats(stats) {
        document.getElementById('statTotal').textContent = stats.total || 0;
        document.getElementById('statRaveXL').textContent = stats['rave-xl'] || 0;
        document.getElementById('statRaveL').textContent = stats['rave-l'] || 0;
        document.getElementById('statMedium').textContent = stats['medium'] || 0;
      },

      updateAnalytics(analytics) {
        document.getElementById('analyticsPageviews').textContent = analytics.todayPageviews || 0;
        document.getElementById('analyticsSessions').textContent = analytics.uniqueSessions || 0;
      },

      renderImages(images) {
        if (!images || images.length === 0) {
          this.elements.uploadedImages.innerHTML = '<p style="color: var(--text-secondary); text-align: center; grid-column: 1/-1;">No hay imagenes en esta categoria.</p>';
          return;
        }

        // Clear container
        this.elements.uploadedImages.innerHTML = '';

        // Create and append items with staggered animation
        images.forEach((img, index) => {
          const item = document.createElement('div');
          item.className = 'uploaded-item item-enter';
          item.dataset.publicId = img.public_id;
          item.style.opacity = '0';
          item.style.animationDelay = `${index * 40}ms`;

          item.innerHTML = `
            <img src="${this.escapeHtml(img.thumbnail)}" alt="Abanico ${this.escapeHtml(img.category)}" loading="lazy">
            <span class="badge">${this.escapeHtml(img.category)}</span>
            <button class="delete-btn" onclick="App.deleteImage('${this.escapeHtml(img.public_id)}')" title="Eliminar" aria-label="Eliminar imagen">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M18 6L6 18M6 6l12 12"/>
              </svg>
            </button>
          `;

          this.elements.uploadedImages.appendChild(item);

          // Trigger animation
          requestAnimationFrame(() => {
            item.style.opacity = '';
          });

          // Remove animation class after completion
          item.addEventListener('animationend', () => {
            item.classList.remove('item-enter');
          }, { once: true });
        });
      },

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },

      showSuccess() {
        this.elements.successMsg.style.display = 'block';
        setTimeout(() => {
          this.elements.successMsg.style.display = 'none';
        }, 3000);
      },

      // Enable upload area after category selection
      enableUploadArea(categoryName) {
        this.elements.uploadArea.classList.remove('disabled');
        this.elements.uploadAreaText.textContent = `Click para seleccionar imagen (${categoryName})`;
      },

      // Show image preview
      showPreview(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          this.elements.previewImg.src = e.target.result;
          this.elements.fileName.textContent = file.name;
          this.elements.imagePreview.classList.add('active');
          this.elements.uploadArea.classList.add('has-file');
        };
        reader.readAsDataURL(file);
      },

      // Clear image preview
      clearPreview() {
        this.elements.previewImg.src = '';
        this.elements.fileName.textContent = '';
        this.elements.imagePreview.classList.remove('active');
        this.elements.uploadArea.classList.remove('has-file');
        this.elements.fileInput.value = '';
        this.selectedFile = null;
        this.updateUploadButton();
      },

      // Update upload button state
      updateUploadButton() {
        const canUpload = this.selectedCategory && this.selectedFile;
        this.elements.uploadBtn.disabled = !canUpload;
      },

      // Show progress bar
      showProgress() {
        this.elements.progressContainer.classList.add('active');
        this.elements.uploadBtn.disabled = true;
        this.elements.uploadBtn.textContent = 'Subiendo...';
      },

      // Update progress
      updateProgress(percent) {
        this.elements.progressFill.style.width = `${percent}%`;
        this.elements.progressText.textContent = `Subiendo... ${Math.round(percent)}%`;
      },

      // Hide progress bar
      hideProgress() {
        this.elements.progressContainer.classList.remove('active');
        this.elements.progressFill.style.width = '0%';
        this.elements.progressText.textContent = 'Subiendo... 0%';
        this.elements.uploadBtn.textContent = 'Subir a Cloudinary';
        this.updateUploadButton();
      },

      // Reset upload form
      resetUploadForm() {
        this.clearPreview();
        this.hideProgress();
      }
    };

    // ================== App Controller ==================
    const App = {
      async init() {
        this.bindEvents();

        if (AuthService.isAuthenticated()) {
          UIController.showAdminPanel();
          await this.loadDashboard();
        } else {
          UIController.showLoginScreen();
        }
      },

      bindEvents() {
        // Login form
        UIController.elements.loginForm.addEventListener('submit', (e) => this.handleLogin(e));

        // Filter change
        UIController.elements.filterCategory.addEventListener('change', () => this.loadImages());

        // Category selection
        document.querySelectorAll('.category-option').forEach(option => {
          option.addEventListener('click', () => this.selectCategory(option));
        });

        // Upload area click -> trigger file input
        UIController.elements.uploadArea.addEventListener('click', () => {
          if (!UIController.elements.uploadArea.classList.contains('disabled')) {
            UIController.elements.fileInput.click();
          }
        });

        // File input change -> show preview
        UIController.elements.fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            this.handleFileSelect(file);
          }
        });

        // Remove button -> clear preview
        UIController.elements.removeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          UIController.clearPreview();
        });

        // Upload button -> upload to Cloudinary
        UIController.elements.uploadBtn.addEventListener('click', () => this.handleUpload());

        // Drag and drop support
        UIController.elements.uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (!UIController.elements.uploadArea.classList.contains('disabled')) {
            UIController.elements.uploadArea.style.borderColor = 'var(--neon-magenta)';
          }
        });

        UIController.elements.uploadArea.addEventListener('dragleave', () => {
          UIController.elements.uploadArea.style.borderColor = '';
        });

        UIController.elements.uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          UIController.elements.uploadArea.style.borderColor = '';
          if (!UIController.elements.uploadArea.classList.contains('disabled')) {
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
              this.handleFileSelect(file);
            }
          }
        });
      },

      async handleLogin(e) {
        e.preventDefault();
        UIController.hideError();
        UIController.setLoading(true);

        try {
          const password = UIController.elements.passwordInput.value;
          const result = await ApiService.login(password);

          if (result.success && result.token) {
            AuthService.setToken(result.token);
            UIController.showAdminPanel();
            await this.loadDashboard();
          } else {
            UIController.showError(result.error || 'Error de autenticacion');
          }
        } catch (error) {
          UIController.showError('Error de conexion');
        } finally {
          UIController.setLoading(false);
        }
      },

      async loadDashboard() {
        await Promise.all([
          this.loadStats(),
          this.loadImages(),
          this.loadAnalytics()
        ]);
      },

      async loadStats() {
        try {
          const result = await ApiService.getStats();
          if (result.success) {
            UIController.updateStats(result.stats);
          }
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      },

      async loadImages() {
        UIController.elements.uploadedImages.innerHTML = '<div class="loading">Cargando imagenes...</div>';

        try {
          const filter = UIController.elements.filterCategory.value;
          const result = await ApiService.getImages(filter);

          if (result.success) {
            UIController.renderImages(result.images);
          }
        } catch (error) {
          console.error('Error loading images:', error);
          UIController.elements.uploadedImages.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Error cargando imagenes.</p>';
        }
      },

      async loadAnalytics() {
        try {
          const result = await ApiService.getAnalytics();
          if (result.success) {
            UIController.updateAnalytics(result.analytics);
          }
        } catch (error) {
          console.error('Error loading analytics:', error);
        }
      },

      selectCategory(option) {
        // Update selected state
        document.querySelectorAll('.category-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');

        const categoryName = option.querySelector('span').textContent;
        UIController.selectedCategory = option.dataset.category;

        // Enable upload area
        UIController.enableUploadArea(categoryName);

        // Update upload button state
        UIController.updateUploadButton();
      },

      handleFileSelect(file) {
        // Validate file type
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          alert('Formato no valido. Usa JPG, PNG o WEBP.');
          return;
        }

        // Validate file size (10MB max)
        if (file.size > 10 * 1024 * 1024) {
          alert('La imagen es muy grande. Maximo 10MB.');
          return;
        }

        // Store file and show preview
        UIController.selectedFile = file;
        UIController.showPreview(file);
        UIController.updateUploadButton();
      },

      async handleUpload() {
        if (!UIController.selectedCategory || !UIController.selectedFile) {
          alert('Selecciona una categoria y una imagen');
          return;
        }

        UIController.showProgress();

        try {
          // Get upload signature from server
          const config = await ApiService.getUploadSignature(UIController.selectedCategory);

          // Upload to Cloudinary using XHR for progress tracking
          const formData = new FormData();
          formData.append('file', UIController.selectedFile);
          formData.append('api_key', config.api_key);
          formData.append('timestamp', config.timestamp);
          formData.append('signature', config.signature);
          formData.append('folder', config.folder);

          const xhr = new XMLHttpRequest();

          // Progress handler
          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const percent = (e.loaded / e.total) * 100;
              UIController.updateProgress(percent);
            }
          });

          // Complete handler
          xhr.addEventListener('load', () => {
            if (xhr.status === 200) {
              const response = JSON.parse(xhr.responseText);
              console.log('Upload successful:', response.public_id);

              UIController.showSuccess();
              UIController.resetUploadForm();

              // Reload gallery and stats
              this.loadStats();
              this.loadImages();
            } else {
              console.error('Upload failed:', xhr.responseText);
              alert('Error subiendo imagen');
              UIController.hideProgress();
            }
          });

          // Error handler
          xhr.addEventListener('error', () => {
            console.error('Upload error');
            alert('Error de conexion al subir');
            UIController.hideProgress();
          });

          // Send request
          xhr.open('POST', `https://api.cloudinary.com/v1_1/${config.cloud_name}/image/upload`);
          xhr.send(formData);

        } catch (error) {
          console.error('Error preparing upload:', error);
          alert('Error preparando subida');
          UIController.hideProgress();
        }
      },

      async deleteImage(publicId) {
        if (!confirm('Eliminar esta imagen?')) return;

        // Find and animate the item out
        const item = document.querySelector(`.uploaded-item[data-public-id="${publicId}"]`);
        if (item) {
          item.classList.add('item-exit');
        }

        try {
          const result = await ApiService.deleteImage(publicId);

          if (result.success) {
            // Wait for exit animation to complete
            if (item) {
              item.addEventListener('animationend', () => {
                item.remove();
                this.loadStats();
                // Only reload if there are items left or container is empty
                const remaining = document.querySelectorAll('.uploaded-item').length;
                if (remaining === 0) {
                  this.loadImages();
                }
              }, { once: true });
            } else {
              this.loadStats();
              this.loadImages();
            }
          } else {
            // Remove exit animation if delete failed
            if (item) {
              item.classList.remove('item-exit');
            }
            alert('Error eliminando imagen: ' + result.error);
          }
        } catch (error) {
          // Remove exit animation on error
          if (item) {
            item.classList.remove('item-exit');
          }
          console.error('Error deleting image:', error);
          alert('Error eliminando imagen');
        }
      }
    };

    // Logout function (global for onclick)
    function logout() {
      AuthService.removeToken();
      location.reload();
    }

    // Initialize app
    App.init();
  </script>
</body>
</html>
